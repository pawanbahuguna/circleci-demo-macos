# Comment to trigger new commit
version: 2.1 
jobs: # a basic unit of work in a run
  build: # runs not using `Workflows` must have a `build` job as entry point
    macos:  # indicate that we are using the macOS executor
      xcode: "13.2.1" # indicate our selected version of Xcode
    resource_class: macos.x86.medium.gen2
    steps: # a series of commands to run
      - checkout  # pull down code from your version control system.
      - run:
          # build our application
          name: Build Application
          command: xcodebuild
      - run:
          name: Compress app for storage
          command: zip -r app.zip build/Release/circleci-demo-macos.app
      - persist_to_workspace:
          root: build/Release/
          paths:
            - circleci-demo-macos.app
      - store_artifacts:
          path: app.zip
          destination: app

  test1: # runs not using `Workflows` must have a `build` job as entry point
    macos:  # indicate that we are using the macOS executor
      xcode: "13.2.1" # indicate our selected version of Xcode
    resource_class: macos.x86.medium.gen2
    steps: # a series of commands to run
      - checkout  # pull down code from your version control system.
      - attach_workspace:
          at: build/Release/
      - run:
          # Create XCTESTRUN file using xcode's cli tool `xcodebuild`
          name: Create XCTESTRUN file
          command: xcodebuild build-for-testing -scheme circleci-demo-macos
      - run:
          # run our tests using xcode's cli tool `xcodebuild`
          name: Run Unit Tests
          command: xcodebuild test-without-building -scheme circleci-demo-macos 
      - store_artifacts:
          path: app.zip
          destination: app

  test2: # runs not using `Workflows` must have a `build` job as entry point
    macos:  # indicate that we are using the macOS executor
      xcode: "13.2.1" # indicate our selected version of Xcode
    resource_class: macos.x86.medium.gen2
    steps: # a series of commands to run
      - checkout  # pull down code from your version control system.
      - attach_workspace:
          at: build/Release/
      - run:
          # Create XCTESTRUN file using xcode's cli tool `xcodebuild`
          name: Create XCTESTRUN file
          command: xcodebuild build-for-testing -scheme circleci-demo-macos2
      - run:
          # run our tests using xcode's cli tool `xcodebuild`
          name: Run Unit Tests
          command: xcodebuild test-without-building -scheme circleci-demo-macos2 
      - store_artifacts:
          path: app.zip
          destination: app

workflows:
  test-and-deploy:
    jobs:
      - build
      - test1:
          requires: [build]
      - test2:
          requires: [build]
